# CDN Gateway Docker Compose - Minimal Production Configuration
#
# Core services start automatically. Dynamic services (trafficserver, traffic-monitor)
# are managed by blockcastd's compose_manager based on mconfig from controller.
#
# Usage:
#   docker compose up -d                    # Start core services
#   docker compose --profile managed up -d  # Start all services (for testing)
#
# For relay services (cache, TR, TM, AMT, MoQ, multicast), see docker-compose.relay.yml

x-service: &service
  image: blockcast/cdn_gateway_go:stable
  restart: always
  stop_grace_period: 30s
  volumes:
    - ${HOME}/.blockcast/certs:/var/opt/magma/certs
    - ${HOME}/.blockcast/snowflake:/etc/snowflake
    - ${HOME}/.blockcast/compose:/etc/magma/compose
    - /var/run/docker.sock:/var/run/docker.sock
  labels:
    blockcast.node: "true"
    managed: "true"

services:
  # Core service - only blockcastd starts on `docker compose up -d`
  # All other services are managed/dynamic and started after bootstrap
  blockcastd:
    <<: *service
    container_name: blockcastd
    command: /usr/bin/blockcastd -logtostderr=true -v=0
    labels:
      blockcast.node: "true"
      managed: "true"
      service.type: "blockcastd"

  # control-proxy: Legacy nghttpx dispatcher (use ingress instead for ATS-based dispatcher)
  # When ingress is in dynamic_services, blockcastd auto-detects and uses it
  control-proxy:
    <<: *service
    container_name: control-proxy
    command: control_proxy
    profiles: [managed]
    labels:
      blockcast.node: "true"
      managed: "true"
      service.type: "control_proxy"

  # ingress: Unified ATS-based ingress (cache + dispatcher on 8443)
  # Replaces control-proxy when using ATS backend
  # Add "ingress" to dynamic_services in mconfig to enable
  ingress:
    image: blockcast/ats:stable
    container_name: ingress
    profiles: [managed]
    restart: always
    stop_grace_period: 60s
    user: "root:root"
    cap_add: [SYS_ADMIN, NET_BIND_SERVICE, CHOWN, SETUID, SETGID]
    environment:
      # ATS dispatcher mode - generates remap.config for cloud routing
      CONTROL_PROXY_BACKEND: "ats"
    ports:
      - "80:80"
      - "443:443"
      - "8443:8443"  # Dispatcher port for cloud mTLS
    devices:
      - ${CACHE0_DEVICE:-/dev/mapper/cache0}:/var/trafficserver/cache0:rwm
    volumes:
      - ${HOME}/.blockcast/certs:/var/opt/magma/certs:ro
      - /etc/magma:/etc/magma:ro
    depends_on:
      trafficserver-init:
        condition: service_completed_successfully
    labels:
      blockcast.node: "true"
      managed: "true"
      service.type: "ingress"
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G

  beacond:
    <<: *service
    container_name: beacond
    command: /usr/bin/beacond -logtostderr=true -v=0
    profiles: [managed]
    labels:
      blockcast.node: "true"
      managed: "true"
      service.type: "beacond"

  # Dynamic relay services (cache, TR, TM, AMT, MoQ, multicast) are defined
  # in docker-compose.relay.yml with profile-based backend selection.
  # Use: docker compose -f docker-compose.yml -f docker-compose.relay.yml --profile <backend> up
